<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Explorador de Resultados (BSS) — Finder Plus</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0e1520; --panel:#121a26; --muted:#9fb0c3; --text:#e6edf6;
    --line:#223246; --accent:#0ea5e9; --sideW:360px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{
    display:grid; grid-template-columns: 320px 1fr var(--sideW);
    gap:14px; padding:14px; height:100%;
  }
  aside, main, .side{
    background:var(--panel); border:1px solid var(--line); border-radius:10px;
  }
  /* ESQUERDA (seletor) */
  aside{padding:12px; overflow:auto}
  h2{margin:0 0 10px; font-size:15px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  select,button,input[type="search"]{
    width:100%; padding:8px 10px; border-radius:8px;
    border:1px solid var(--line); background:#0b111b; color:var(--text);
  }
  .muted{color:var(--muted)}
  .list{border:1px solid var(--line); border-radius:8px; background:#0b111b;
        max-height:65vh; overflow:auto}
  .exec{display:grid; grid-template-columns: 24px 1fr auto; gap:8px;
        align-items:center; padding:8px 10px; border-bottom:1px solid #0f1a29}
  .exec:hover{background:#0f1926}
  .add{width:22px;height:22px; display:grid; place-items:center; cursor:pointer;
       background:#0a121d; border:1px solid #1d2a3a; color:#a5d8ff; border-radius:6px}
  .badge{background:#1b2736; border:1px solid #27384d; padding:2px 8px;
         border-radius:999px; font-size:11px; color:#bdd1e6}
  small{color:var(--muted)}
  /* CENTRO (gráfico) */
  main{padding:12px; display:grid; grid-template-rows: auto 1fr; gap:10px; min-width:0}
  .toolbar{display:grid; grid-template-columns: 220px 1fr 180px 120px; gap:8px}
  button.primary{background:#0b1320; border-color:#26364a}
  .plot{height:60vh; border:1px solid var(--line); border-radius:10px;
        background:#0b111b; overflow:hidden}
  /* DIREITA (painel de séries) */
  .side{display:grid; grid-template-rows: auto 1fr; overflow:hidden}
  .sideHead{padding:10px; display:flex; gap:8px; align-items:center;
            border-bottom:1px solid var(--line)}
  .sideBody{overflow:auto; padding:10px}
  .file-card{border:1px solid #1a2536; border-radius:10px; padding:8px; margin-bottom:10px; background:#0e1622}
  .file-head{display:flex; align-items:center; gap:10px; margin-bottom:8px; font-size:13px}
  .dot{width:10px; height:10px; border-radius:50%; display:inline-block}
  .file-actions{margin-left:auto; display:flex; gap:8px}
  .file-actions a{color:#88caff; text-decoration:none; font-size:12px}
  .cols-tools{display:flex; gap:8px; align-items:center; margin-bottom:6px}
  .cols-grid{display:grid; grid-template-columns: repeat(3, minmax(150px,1fr));
             gap:4px 10px; max-height:180px; overflow:auto; padding-right:6px; font-size:12px}
  .ch{display:flex; align-items:center; gap:6px; white-space:nowrap}
  .ch input{accent-color:#0ea5e9}
  /* colapsar painel direito */
  .side.closed{width:0; border:none; padding:0; overflow:hidden}
  .side.closed *{display:none}
  /* responsivo */
  @media (max-width:1200px){
    .cols-grid{grid-template-columns: repeat(2, minmax(140px,1fr))}
  }
  @media (max-width:980px){
    .wrap{grid-template-columns: 1fr; grid-template-rows: auto auto auto}
    .side{order:3}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- ESQUERDA -->
  <aside>
    <h2>Selecionar arquivo</h2>
    <div style="margin-bottom:10px">
      <label>Estudo de Caso</label>
      <select id="caseSel"></select>
    </div>
    <div>
      <label>Execuções disponíveis</label>
      <div id="execList" class="list"><div class="muted" style="padding:10px">Carregando índice…</div></div>
      <p class="muted" style="margin:8px 2px 0">
        Clique em <span class="badge">+</span> para adicionar a execução ao gráfico.
      </p>
    </div>
  </aside>

  <!-- CENTRO -->
  <main>
    <div class="toolbar">
      <div>
        <label>Coluna X (global)</label>
        <select id="xSel"><option value="period">period</option></select>
      </div>
      <button id="btnUpdate" class="primary">Atualizar gráfico</button>
      <button id="btnToggleSide">Séries ▸</button>
      <button id="btnClear">Limpar gráfico</button>
    </div>
    <div id="plot" class="plot"></div>
  </main>

  <!-- DIREITA (PAINEL COLAPSÁVEL) -->
  <div id="side" class="side">
    <div class="sideHead">
      <strong>Séries do gráfico</strong>
      <span class="muted" style="margin-left:auto">marque/desmarque para exibir</span>
    </div>
    <div id="filesBox" class="sideBody">
      <div class="muted">Nenhum arquivo adicionado ainda.</div>
    </div>
  </div>
</div>

<script>
/* ---------- util ---------- */
const scenarioByBSS = (bss)=>{
  const map = { "728":"1 — BSS 728", "330":"2 — BSS 330", "420":"3 — BSS 420", "179":"4 — BSS 179" };
  return map[String(bss)] || `BSS ${bss}`;
};
const algLabel = (tok)=>{
  const t = String(tok).toUpperCase();
  if (t==="MOEAD_H") return "MOEA/D-H";
  if (t==="MOEAD_C") return "MOEA/D-C";
  if (t==="MOEAD_PY"||t==="MOEAD"||t==="MOEAD_P") return "MOEA/D (Py)";
  if (t==="NSGA2_PY"||t==="NSGA2") return "NSGA-II (Py)";
  if (t==="NSPSO_PY"||t==="NSPSO") return "NSPSO (Py)";
  if (t==="MACO_PY"||t==="MACO") return "MACO (Py)";
  if (t==="PLIM") return "PLIM";
  return tok.replace(/_/g,"/");
};
const modeLabel=(P)=> String(P)==="1" ? "P1 — Preditivo" : "P0 — Reativo";
const rdLabel=(RD)=> String(RD)==="1" ? "✓ RD" : "✗ RD";
const parseMeta=(fname)=>{
  // ID{BSS}_{ALG}_DF_P{P}_RD{RD}_YYYY-MM-DD_...
  const re=/^ID(\d+)_([A-Za-z0-9]+(?:_[A-Za-z0-9]+)*)_DF_P([01])_RD([01])_/i;
  const m=fname.match(re); if(!m) return {bss:"?",alg:"?",P:"?",RD:"?"};
  return {bss:m[1],alg:m[2],P:m[3],RD:m[4]};
};
const short=(s)=>s.replace(/\.xlsx$/i,'');
const palette=["#60a5fa","#f43f5e","#22d3ee","#f59e0b","#a78bfa","#10b981","#e879f9","#fb7185","#34d399","#fcd34d"];
const colorOf=(i)=>palette[i%palette.length];
const debounce=(fn,ms=180)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

/* ---------- estado ---------- */
let INDEX=[];           // index.json
let BYCASE=new Map();   // case -> files
let CASES=[];           // lista de cases
let LOADED=[];          // {file,data,color,id}
let cache=new Map();    // url->rows

/* ---------- dom ---------- */
const caseSel=document.getElementById('caseSel');
const execList=document.getElementById('execList');
const xSel=document.getElementById('xSel');
const plotEl=document.getElementById('plot');
const filesBox=document.getElementById('filesBox');
const btnUpdate=document.getElementById('btnUpdate');
const btnClear=document.getElementById('btnClear');
const btnToggleSide=document.getElementById('btnToggleSide');
const side=document.getElementById('side');

/* ---------- index ---------- */
async function loadIndex(){
  const res=await fetch('index.json',{cache:'no-store'});
  const j=await res.json();
  INDEX=j.files||[];

  BYCASE.clear();
  for(const f of INDEX){
    const m=f.relpath.match(/Estudo de Caso\s+(\d+)\//i);
    const c=m?m[1]:'1';
    if(!BYCASE.has(c)) BYCASE.set(c,[]);
    BYCASE.get(c).push(f);
  }
  CASES=[...BYCASE.keys()].sort((a,b)=>+a-+b);
  caseSel.innerHTML=CASES.map(c=>`<option value="${c}">Estudo de Caso ${c}</option>`).join('');
  caseSel.onchange=renderExecs;
  renderExecs();
}
function renderExecs(){
  const c=caseSel.value||CASES[0];
  const files=BYCASE.get(c)||[];
  if(!files.length){
    execList.innerHTML=`<div class="muted" style="padding:10px">Nenhum arquivo para o Estudo de Caso ${c}.</div>`;
    return;
  }
  execList.innerHTML=files.map(f=>{
    const m=parseMeta(f.name);
    const rot=`${scenarioByBSS(m.bss)} — ${algLabel(m.alg)} — ${modeLabel(m.P)} — ${rdLabel(m.RD)}`;
    return `<div class="exec">
      <div class="add" onclick="addFile('${f.url}')">+</div>
      <div><div>${rot}</div><small class="muted">${short(f.name)}</small></div>
      <div><span class="badge">xlsx</span></div>
    </div>`;
  }).join('');
}

/* ---------- dados ---------- */
async function getRows(url){
  if(cache.has(url)) return cache.get(url);
  const r=await fetch(url); const ab=await r.arrayBuffer();
  const wb=XLSX.read(ab,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{defval:null}); cache.set(url,rows);
  return rows;
}

/* ---------- carregar/remover ---------- */
async function addFile(url){
  if(LOADED.find(x=>x.file.url===url)) return;
  const file=INDEX.find(f=>f.url===url); if(!file) return;
  const data=await getRows(url);
  const color=colorOf(LOADED.length);
  const id='F'+LOADED.length;
  LOADED.push({file,data,color,id});
  addFileCard(LOADED.at(-1));
}
function removeFile(id){
  LOADED=LOADED.filter(x=>x.id!==id);
  filesBox.querySelector(`[data-file="${id}"]`)?.remove();
  if(!LOADED.length) filesBox.innerHTML='<div class="muted">Nenhum arquivo adicionado ainda.</div>';
  renderPlot();
}

function addFileCard(item){
  if(filesBox.textContent.includes('Nenhum arquivo')) filesBox.innerHTML='';
  const m=parseMeta(item.file.name);
  const header=`${scenarioByBSS(m.bss)} — ${algLabel(m.alg)} — ${modeLabel(m.P)} — ${rdLabel(m.RD)}`;
  const cols=(item.file.cols||[]).filter(c=>c&&c!=='period');

  const el=document.createElement('div');
  el.className='file-card';
  el.dataset.file=item.id;
  el.innerHTML=`
    <div class="file-head">
      <span class="dot" style="background:${item.color}"></span>
      <div><strong>${header}</strong><br><small class="muted">${short(item.file.name)}</small></div>
      <div class="file-actions">
        <a href="#" data-act="selall">Selecionar todas</a>
        <a href="#" data-act="clear">Limpar</a>
        <a href="#" data-act="remove" style="color:#ff9aa2">Remover</a>
      </div>
    </div>
    <div class="cols-tools">
      <input type="search" placeholder="filtrar colunas…" data-filter>
    </div>
    <div class="cols-grid" data-grid></div>
  `;
  const grid=el.querySelector('[data-grid]');
  grid.innerHTML=cols.map(c=>`<label class="ch" data-col="${c}">
    <input type="checkbox" data-colcheck value="${c}"><span>${c}</span>
  </label>`).join('');

  el.addEventListener('click',ev=>{
    const act=ev.target?.dataset?.act; if(!act) return;
    ev.preventDefault();
    if(act==='selall') grid.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=true);
    if(act==='clear')  grid.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.checked=false);
    if(act==='remove') removeFile(item.id);
    renderPlotDebounced();
  });
  el.addEventListener('change',ev=>{
    if(ev.target.matches('input[data-colcheck]')) renderPlotDebounced();
  });
  const filter=el.querySelector('[data-filter]');
  filter.addEventListener('input',()=>{
    const q=filter.value.trim().toLowerCase();
    grid.querySelectorAll('.ch').forEach(n=>{
      n.style.display=!q || n.dataset.col.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  filesBox.appendChild(el);
}

/* ---------- plot ---------- */
function buildTraces(){
  const xName=xSel.value||'period';
  const traces=[];
  LOADED.forEach((it,idx)=>{
    const card=filesBox.querySelector(`[data-file="${it.id}"]`);
    if(!card) return;
    const x=it.data.map(r=>r?.[xName]);
    const checks=[...card.querySelectorAll('input[data-colcheck]:checked')];
    checks.forEach((ch,i)=>{
      const col=ch.value;
      traces.push({
        x, y: it.data.map(r=>r?.[col]),
        type:'scatter', mode:'lines',
        name: `${short(it.file.name)} — ${col}`,
        line:{color:it.color, width:2, dash:(i%2?'dash':'solid')}
      });
    });
  });
  return traces;
}
function renderPlot(){
  const traces=buildTraces();
  const layout={
    paper_bgcolor:'#0b111b', plot_bgcolor:'#0b111b',
    font:{color:'#cfe3ff'}, margin:{l:60,r:20,t:10,b:40},
    xaxis:{gridcolor:'#172334', zerolinecolor:'#172334'},
    yaxis:{gridcolor:'#172334', zerolinecolor:'#172334', title:'Valor'},
    legend:{orientation:'h', y:-0.2}
  };
  Plotly.react(plotEl, traces, layout, {displaylogo:false, responsive:true});
}
const renderPlotDebounced = debounce(renderPlot, 150);

/* ---------- wiring ---------- */
btnUpdate.onclick=renderPlot;
btnClear.onclick=()=>{
  LOADED=[]; filesBox.innerHTML='<div class="muted">Nenhum arquivo adicionado ainda.</div>';
  Plotly.purge(plotEl);
};
btnToggleSide.onclick=()=>{
  side.classList.toggle('closed');
  // força reflow do Plotly para relayout quando a largura muda
  setTimeout(()=>Plotly.Plots.resize(plotEl), 180);
};
window.addEventListener('resize', debounce(()=>Plotly.Plots.resize(plotEl), 100));

document.addEventListener('DOMContentLoaded', async ()=>{
  try{ await loadIndex(); }
  catch(e){ console.error(e); execList.innerHTML='<div class="muted" style="padding:10px">Erro ao carregar o índice.</div>'; }
});
</script>
</body>
</html>
