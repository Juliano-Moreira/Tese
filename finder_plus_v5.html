<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Explorador de Resultados (BSS) — Finder Plus</title>

<!-- Plotly e XLSX -->
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#f7f7fb;
    --panel:#ffffff;
    --muted:#6b7280;
    --text:#1f2937;
    --accent:#2563eb;
    --border:#e5e7eb;
    --chip:#eef2ff;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.35 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .app{
    display:grid;
    grid-template-columns: 320px 1fr 360px;
    gap:12px; padding:12px;
    height:100%;
    box-sizing:border-box;
  }
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:10px;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    overflow:hidden; display:flex; flex-direction:column;
    min-height:0;
  }
  .card .head{
    padding:10px 12px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card .head h3{margin:0; font-size:15px}
  .btn{
    background:#fff; border:1px solid var(--border); border-radius:8px;
    padding:6px 10px; cursor:pointer; color:var(--text);
  }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.ghost{ background:transparent }
  .btn.small{ padding:4px 8px; font-size:12px }
  .muted{ color:var(--muted) }
  .scroll{ overflow:auto }
  .left, .right{ min-width:0 }
  .left.collapsed, .right.collapsed{ display:none }
  .grid-row{ padding:10px 12px; border-bottom:1px solid var(--border) }
  .grid-row:last-child{ border-bottom:none }
  select, input[type="text"]{
    width:100%; padding:8px 10px; border:1px solid var(--border);
    border-radius:8px; background:#fff; color:var(--text);
  }
  /* lista de execuções */
  .run{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:10px; border:1px solid var(--border); border-radius:8px; background:#fff;
  }
  .run + .run{ margin-top:8px }
  .run .title{ font-weight:600; }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:4px }
  .chip{
    background:var(--chip); border:1px solid #c7d2fe; color:#374151;
    padding:2px 6px; border-radius:999px; font-size:12px
  }
  .run .actions{ display:flex; gap:6px }
  .link{ color:var(--accent); text-decoration:none }
  .add{ background:#10b981; color:#fff; border-color:#10b981 }
  /* séries por execução (direita) */
  .series-block{ border-top:1px dashed var(--border); padding-top:10px; margin-top:10px }
  .series-head{
    display:grid; grid-template-columns: 1fr 140px; gap:8px; align-items:center; margin-bottom:8px;
  }
  .series-head .id{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .series-list{
    display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
    gap:6px 14px; max-height:240px; overflow:auto; padding-right:6px
  }
  .series-item{ display:flex; align-items:center; gap:8px; white-space:nowrap }
  .series-item input{ transform:translateY(1px) }
  .legend-help{
    display:inline-flex; align-items:center; gap:6px; cursor:pointer; color:var(--accent);
    font-size:12px; padding:2px 6px; border-radius:6px; background:#eef2ff; border:1px solid #c7d2fe;
  }
  .help-box{ display:none; padding:10px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; margin-top:8px }
  .help-box.show{ display:block }
  /* botões de colapso */
  .collapse-btn{
    border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:12px
  }
  /* botão flutuante para reabrir filtros */
  #showLeft{
    position:fixed; left:10px; top:10px; z-index:10; display:none;
    background:#111827; color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer;
  }
  /* plot container */
  #plot{ width:100%; height:100% }
  .plot-wrap{ padding:10px }
  /* barra superior do gráfico */
  .plot-top{
    display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border)
  }
  .grow{ flex:1 }
  @media (max-width:1200px){
    .app{ grid-template-columns: 1fr }
    .right{ order:3 }
  }
</style>
</head>
<body>
<button id="showLeft">Mostrar filtros</button>

<div class="app">

  <!-- PAINEL ESQUERDO -->
  <section class="card left" id="leftPanel">
    <div class="head">
      <h3>Estudo de Caso</h3>
      <button class="collapse-btn" id="collapseLeft">esconder</button>
    </div>
    <div class="grid-row">
      <select id="caseSelect"></select>
    </div>
    <div class="grid-row muted">Execuções disponíveis</div>
    <div class="scroll" id="runsList" style="padding:10px 12px;"></div>
    <div class="grid-row muted" style="font-size:12px">
      Clique em <b class="muted">+</b> para adicionar a execução ao gráfico. Os arquivos são lidos diretamente do repositório (GitHub Pages).
    </div>
  </section>

  <!-- PAINEL CENTRAL / GRÁFICO -->
  <section class="card center">
    <div class="plot-top">
      <div class="grow">
        <label class="muted" style="display:block;font-size:12px;margin-bottom:4px">Eixo X inferior</label>
        <select id="xSelect">
          <option value="period">period (1…96)</option>
        </select>
      </div>
      <button id="btnUpdate" class="btn primary">Atualizar</button>
      <button id="btnClear" class="btn">Limpar</button>
      <button class="collapse-btn" id="collapseRightToggle"><span id="rightTglText" class="muted">mostrar séries</span></button>
    </div>
    <div class="plot-wrap">
      <div id="plot"></div>
    </div>
  </section>

  <!-- PAINEL DIREITO / SÉRIES -->
  <section class="card right" id="rightPanel">
    <div class="head">
      <h3>Séries do gráfico <span class="muted">— marque/desmarque para exibir</span></h3>
      <div>
        <button class="legend-help" id="helpTgl">?</button>
        <button class="collapse-btn" id="collapseRight">esconder</button>
      </div>
    </div>
    <div class="help-box" id="helpBox">
      <div style="font-weight:700;margin-bottom:6px">Formação do nome do arquivo</div>
      <pre style="white-space:pre-wrap;margin:0">
ID### (identificação)
_Algoritmo_DF: Algoritmo ∈ { MOEAD_H, MOEAD_C, nsga2_PY, maco_PY, moead_PY, nspso_PY, PLIM }
_P#: Modo Preditivo-Otimizado (1) ou Reativo-Otimizado (0)
_RD#: Resposta à Demanda — habilitada (1) ou não (0)
_G##: Número de gerações (opcional)
_####…#: Seed (opcional; usado no Estudo de Caso 7)
      </pre>
    </div>
    <div class="scroll" id="seriesPanel" style="padding:10px 12px;"></div>
  </section>

</div>

<script>
// -------------------------------
// Helpers / estado global
// -------------------------------
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const leftPanel   = $('#leftPanel');
const rightPanel  = $('#rightPanel');
const runsList    = $('#runsList');
const caseSelect  = $('#caseSelect');
const seriesPanel = $('#seriesPanel');
const xSelect     = $('#xSelect');
const helpTgl     = $('#helpTgl');
const helpBox     = $('#helpBox');
const showLeftBtn = $('#showLeft');
const rightTglText= $('#rightTglText');

const ACTIVE = [];     // [{ meta, file, data, cols, checked:Set<string>, block:HTMLElement }]
const LOADED = {};     // url -> { data:Array<Record>, cols:Set<string> }

let INDEX = [];        // do index.json
let CASES = [];        // nomes únicos de estudo de caso

// -------------------------------
// Labels bonitos para algoritmos
// -------------------------------
const ALG_LABELS = {
  "MOEAD_H": "MOEA/D-H",
  "MOEAD_C": "MOEA/D-C",
  "NSGA2_PY": "NSGA2 PY",
  "MACO_PY": "MACO PY",
  "MOEAD_PY": "MOEAD PY",
  "NSPSO_PY": "NSPSO PY",
  "PLIM": "PLIM",
};

// -------------------------------
// Regex robusta para nomes
// -------------------------------
const FILE_RE = /^ID(?<id>\d+)_(?<alg>[A-Za-z0-9]+(?:_[A-Za-z0-9]+)*)_DF_P(?<P>[01])_RD(?<RD>[01])(?:_G(?<G>\d+))?(?:_(?<seed>\d{4,}))?\.xlsx$/i;

function parseFilenameMeta(fileName){
  const m = FILE_RE.exec(fileName.trim());
  if(!m) return null;
  const g = m.groups;
  const id = Number(g.id);
  const P = Number(g.P);
  const RD = Number(g.RD);
  const G  = g.G ? Number(g.G) : null;
  const seed = g.seed || null;

  const algKey = g.alg.toUpperCase();
  const algLabel = ALG_LABELS[algKey] || g.alg.replace(/_/g,'-');

  // Título conciso (sem textos longos)
  const concise = `ID${id} — ${algLabel} — P${P} — RD${RD}${G?` — G${G}`:''}`;

  return {
    id,P,RD,G,seed, algKey, algRaw:g.alg, algLabel,
    runKey:`ID${id}_${g.alg}_P${P}_RD${RD}${G?`_G${G}`:""}${seed?`_${seed}`:""}`,
    titleConcise: concise,
    shortId:`ID${id}_${algLabel}_P${P}_RD${RD}${G?` — G${G}`:''}`
  };
}

// -------------------------------
// Carrega index.json e hidrata UI
// -------------------------------
async function loadIndex(){
  const res = await fetch('index.json');
  if(!res.ok) throw new Error('Falha ao carregar index.json');
  const js = await res.json();
  INDEX = js.files || [];

  // extrai estudo de caso pela pasta do relpath
  CASES = Array.from(new Set(INDEX.map(f => {
    // "Resultados/Estudo de Caso X/Resultado Final/..."
    const parts = (f.relpath||'').split('/');
    const pos = parts.findIndex(p => /^Estudo de Caso /.test(p));
    return pos>=0? parts[pos] : 'Estudo de Caso 1';
  }))).sort((a,b)=>{
    const na = Number(a.replace(/\D+/g,'')||'0');
    const nb = Number(b.replace(/\D+/g,'')||'0');
    return na-nb;
  });

  caseSelect.innerHTML = CASES.map(c => `<option>${c}</option>`).join('');
  hydrateRuns();
}

function hydrateRuns(){
  const selectedCase = caseSelect.value || CASES[0];
  const runs = INDEX.filter(f => (f.relpath||'').includes(`/${selectedCase}/`));

  runsList.innerHTML = '';
  runs.forEach(f=>{
    const meta = parseFilenameMeta(f.name||'');
    const row = document.createElement('div');
    row.className = 'run';

    if(!meta){
      row.innerHTML = `
        <div style="min-width:0">
          <div class="title">${f.name||'arquivo'}</div>
          <div class="muted" style="font-size:12px">formato de nome não suportado</div>
        </div>
        <div class="actions"><a class="btn small" href="${f.url}" target="_blank">xlsx</a></div>
      `;
    }else{
      row.innerHTML = `
        <div style="min-width:0">
          <div class="title">${meta.titleConcise}</div>
          <div class="chips">
            <span class="chip">${meta.algLabel}</span>
            <span class="chip">P${meta.P}</span>
            <span class="chip">RD${meta.RD}</span>
            ${meta.G ? `<span class="chip">G${meta.G}</span>`:''}
            ${meta.seed ? `<span class="chip">seed ${meta.seed}</span>`:''}
          </div>
        </div>
        <div class="actions">
          <a class="btn small" href="${f.url}" target="_blank">xlsx</a>
          <button class="btn small add">+</button>
        </div>
      `;
      row.querySelector('button.add').onclick = ()=> addRun({file:f, meta});
    }
    runsList.appendChild(row);
  });
}

// -------------------------------
// Carregar XLSX uma vez por URL
// -------------------------------
async function loadXlsx(url){
  if(LOADED[url]) return LOADED[url];
  const res = await fetch(url);
  if(!res.ok) throw new Error('Falha ao carregar XLSX: '+url);
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab, {type:'array'});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(sheet, {defval:null});
  const cols = new Set(Object.keys(data[0]||{}));
  LOADED[url] = {data, cols};
  return LOADED[url];
}

// heurística: mandar custos e receitas para eixo direito (R$)
function isMonetary(col){
  return /^cost|^revenue/i.test(col) || /_cost$|_total$|_period$|_period_total/i.test(col);
}

// -------------------------------
/*  Painéis e séries                                                  */
// -------------------------------
async function addRun({file, meta}){
  const {data, cols} = await loadXlsx(file.url);

  // bloco de séries (direita)
  const block = document.createElement('div');
  block.className = 'series-block';
  block.dataset.url = file.url;

  const filterId = 'flt_'+Math.random().toString(36).slice(2);

  block.innerHTML = `
    <div class="series-head">
      <div class="id" title="${meta.shortId}">${meta.shortId}</div>
      <input id="${filterId}" type="text" placeholder="filtrar colunas…"/>
    </div>
    <div class="series-list"></div>
  `;
  seriesPanel.appendChild(block);

  const list = block.querySelector('.series-list');
  const arrCols = Array.from(cols).sort();

  // pré-selecionadas
  const defaults = new Set(['E_virtual','e_Resultant','Cost_Period_Total']);

  arrCols.forEach(col=>{
    const id = `${meta.runKey}__${col}`;
    const it = document.createElement('label');
    it.className = 'series-item';
    it.title = col;
    it.innerHTML = `<input type="checkbox" data-col="${col}" id="${id}"> <span>${col}</span>`;
    const cb = it.querySelector('input');
    if(defaults.has(col)) cb.checked = true;
    // atualização automática
    cb.addEventListener('change', draw);
    list.appendChild(it);
  });

  // filtrar
  const flt = block.querySelector('#'+filterId);
  flt.addEventListener('input', ()=>{
    const q = flt.value.trim().toLowerCase();
    list.querySelectorAll('.series-item').forEach(li=>{
      const t = li.title.toLowerCase();
      li.style.display = t.includes(q) ? '' : 'none';
    });
  });

  // guarda ACTIVE
  ACTIVE.push({ meta, file, cols:arrCols, data, block });

  draw();
}

function selectedSeries(){
  const groups = [];
  ACTIVE.forEach(run=>{
    const checkeds = Array.from(run.block.querySelectorAll('input[type="checkbox"]:checked'))
      .map(i=> i.dataset.col);
    if(checkeds.length>0){
      groups.push({ run, cols:checkeds });
    }
  });
  return groups;
}

// -------------------------------
// Eixo X superior — Hora (a cada 1h)
function hourTicks(){
  const ticks = [];
  const labs  = [];
  for(let h=0; h<24; h++){
    const period = 1 + h*4;         // 1,5,9,...,93
    ticks.push(period);
    const hh = String(h).padStart(2,'0');
    labs.push(`${hh}:00`);
  }
  return {ticks, labs};
}

// -------------------------------
// Desenhar gráfico (com legendas agrupadas)
// -------------------------------
function draw(){
  const traces = [];
  const xField = xSelect.value || 'period';
  const {ticks, labs} = hourTicks();
  const groupFirst = new Map(); // legendgroup -> bool

  selectedSeries().forEach(({run, cols})=>{
    const X = run.data.map(r => Number(r[xField]));
    cols.forEach((col, idx)=>{
      const isFirst = !groupFirst.has(run.meta.shortId);
      groupFirst.set(run.meta.shortId, true);
      traces.push({
        x:X, y: run.data.map(r => (r[col]==null? null : Number(r[col]))),
        mode:'lines',
        name: col,                          // só o nome da coluna
        legendgroup: run.meta.shortId,      // agrupa
        ...(isFirst ? { legendgrouptitle:{text: run.meta.shortId} } : {}),
        yaxis: isMonetary(col) ? 'y2' : 'y1'
      });
    });
  });

  const layout = {
    margin:{l:60,r:60,t:10,b:50},
    xaxis:{
      title:'period',
      tickmode:'linear', dtick:4,
      zeroline:false, showgrid:true, gridcolor:'#f1f5f9'
    },
    xaxis2:{
      overlaying:'x', side:'top', anchor:'y',
      tickvals:ticks, ticktext:labs,
      tickangle:-45, ticklabelposition:'outside top',
      showgrid:false, zeroline:false
    },
    yaxis:{
      title:'kWh / kW / contagem',
      zeroline:false, gridcolor:'#eef2f7'
    },
    yaxis2:{
      title:'R$', overlaying:'y', side:'right',
      zeroline:false, gridcolor:'#eef2f7'
    },
    legend:{orientation:'h', x:0, y:-0.2},
    paper_bgcolor:'#fff',
    plot_bgcolor:'#fff'
  };

  Plotly.newPlot('plot', traces, layout, {displaylogo:false, responsive:true});
}

// -------------------------------
// Resize util (para quando colapsa/expande)
// -------------------------------
function resizePlot(){
  const el = document.getElementById('plot');
  if(el && el.data){ Plotly.Plots.resize(el); }
  // fallback
  setTimeout(()=>{ if(el) Plotly.Plots.resize(el) }, 50);
}

// -------------------------------
// Eventos UI
// -------------------------------
$('#btnUpdate').onclick = draw;
$('#btnClear').onclick = ()=>{
  ACTIVE.splice(0,ACTIVE.length);
  seriesPanel.innerHTML='';
  draw();
};

$('#collapseLeft').onclick = ()=>{
  leftPanel.classList.add('collapsed');
  showLeftBtn.style.display = 'inline-block';
  resizePlot();
};
showLeftBtn.onclick = ()=>{
  leftPanel.classList.remove('collapsed');
  showLeftBtn.style.display = 'none';
  resizePlot();
};

$('#collapseRight').onclick = ()=>{
  rightPanel.classList.add('collapsed');
  rightTglText.textContent = 'mostrar séries';
  resizePlot();
};
$('#collapseRightToggle').onclick = ()=>{
  const willShow = rightPanel.classList.contains('collapsed');
  rightPanel.classList.toggle('collapsed');
  rightTglText.textContent = willShow ? 'ocultar séries' : 'mostrar séries';
  resizePlot();
};

helpTgl.onclick = ()=> helpBox.classList.toggle('show');

caseSelect.onchange = hydrateRuns;

// Redimensiona Plotly quando a janela muda
window.addEventListener('resize', resizePlot);

// -------------------------------
// Boot
// -------------------------------
loadIndex().catch(err=>{
  console.error(err);
  runsList.innerHTML = `<div class="muted">Erro ao carregar o índice.</div>`;
});
</script>
</body>
</html>
