<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Explorador de Resultados (BSS) — Finder Plus</title>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#f7f7fb;
    --panel:#ffffff;
    --muted:#6b7280;
    --text:#1f2937;
    --accent:#2563eb;
    --border:#e5e7eb;
    --chip:#eef2ff;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.35 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .app{
    display:grid;
    grid-template-columns: 320px 1fr 360px;
    gap:12px; padding:12px;
    height:100%;
    box-sizing:border-box;
  }
  .app.left-collapsed{ grid-template-columns: 0 1fr 360px; }

  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:10px;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    overflow:hidden; display:flex; flex-direction:column;
    min-height:0;
  }
  .card .head{
    padding:10px 12px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card .head h3{margin:0; font-size:15px}
  .btn{
    background:#fff; border:1px solid var(--border); border-radius:8px;
    padding:6px 10px; cursor:pointer; color:var(--text);
  }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.small{ padding:4px 8px; font-size:12px }
  .muted{ color:var(--muted) }
  .scroll{ overflow:auto }
  .left, .right{ min-width:0 }
  .left.collapsed{ display:none }

  .grid-row{ padding:10px 12px; border-bottom:1px solid var(--border) }
  .grid-row:last-child{ border-bottom:none }
  select, input[type="text"]{
    width:100%; padding:8px 10px; border:1px solid var(--border);
    border-radius:8px; background:#fff; color:#1f2937;
  }

  /* lista de execuções */
  .run{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:10px; border:1px solid var(--border); border-radius:8px; background:#fff;
  }
  .run + .run{ margin-top:8px }
  .run .title{ font-weight:700; font-size:15px }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:4px }
  .chip{
    background:var(--chip); border:1px solid #c7d2fe; color:#374151;
    padding:2px 6px; border-radius:999px; font-size:12px
  }
  .run .actions{ display:flex; gap:6px }
  .add{ background:#10b981; color:#fff; border-color:#10b981 }

  /* painéis esquerdo/direito com escala */
  .left, .right{ --panel-scale: .8; font-size: calc(14px * var(--panel-scale)); }


  .series-block{ border-top:1px dashed var(--border); padding-top:10px; margin-top:10px }
  .series-head{
    display:grid; grid-template-columns: 1fr 140px; gap:8px; align-items:center; margin-bottom:8px;
  }
  .series-head .id{ font-size:12px }

  .series-head .id{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .series-list{
    display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
    gap:6px 14px; max-height:240px; overflow:auto; padding-right:6px
  }
  .series-item{ display:flex; align-items:center; gap:8px; white-space:nowrap }
  .series-item input{ transform:translateY(1px) }
  .legend-help{
    display:inline-flex; align-items:center; gap:6px; cursor:pointer; color:var(--accent);
    font-size:12px; padding:2px 6px; border-radius:6px; background:#eef2ff; border:1px solid #c7d2fe;
  }
  .help-box{ display:none; padding:10px; background:#f9fafb; border:1px solid var(--border); border-radius:8px; margin-top:8px }
  .help-box.show{ display:block }
  .collapse-btn{ border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:12px }
  #showLeft{
    position:fixed; left:10px; top:10px; z-index:10; display:none;
    background:#111827; color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer;
  }
  #plot{ width:100%; height:100% }

  /* centro com rolagem */
  .plot-top{
    display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border)
  }
  .center-scroll{ display:flex; flex-direction:column; gap:10px; padding:10px 12px; min-height:0; overflow:auto }
  .plot-wrap{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px }
  .plot-below{ display:flex; flex-direction:column; gap:10px; }
  .subpanel{
    border:1px solid var(--border); border-radius:10px; background:#fff; padding:10px 12px;
  }
  .subpanel details>summary{ cursor:pointer }
  .help-pre{ white-space:pre-wrap; font-size:.9em; margin:.5rem 0 0 }
  #bat-requests .row{ display:flex; gap:1rem; align-items:center; margin:.25rem 0 .5rem; }
  #bat-requests table.mini{ width:100%; border-collapse:collapse; font-size:.9em; }
  #bat-requests table.mini th, #bat-requests table.mini td{ border:1px solid #e5e7eb; padding:.25rem .5rem; }

  @media (max-width:1200px){
    .app{ grid-template-columns: 1fr }
    .right{ order:3 }
  }
  
	/* painel direito realmente colapsa */
	.app.right-collapsed{ grid-template-columns: 320px 1fr 0; }
	.right.collapsed{ display:none }

	/* fontes menores/escala no painel ESQUERDO (ID/chips/botões) */
	.left .run { gap:6px; padding:8px; }
	.left .run .title{ font-size: calc(13px * var(--panel-scale)); }
	.left .chips{ gap:4px }
	.left .chip{
	  font-size: calc(10px * var(--panel-scale));
	  padding: 1px 6px;
	}
	.left .btn.small{
	  font-size: calc(11px * var(--panel-scale));
	  padding: 3px 7px;
	}
	
  .btn.ghost{ background:transparent; color:var(--accent); border-color:var(--accent) }

  /* barra de âncoras (no painel direito) */
  .anchor-bar{
    padding:8px 12px;
    border-bottom:1px solid var(--border);
    display:flex; flex-wrap:wrap;
    gap:8px 10px;            /* respiro horizontal e vertical */
    align-items:flex-start;
  }
  .anchor-bar h3{
    margin:0 0 6px 0;        /* separa o título dos botões */
    font-size:13px; font-weight:700;
    flex-basis:100%;         /* força o título a ocupar a linha inteira */
  }
  .anchor-bar a{
    font-size:12px; color:var(--accent); text-decoration:none;
    padding:2px 6px; border:1px solid #c7d2fe; background:#eef2ff; border-radius:6px;
  }
  
  #exec-summary table.mini th, #exec-summary table.mini td{ padding:.35rem .5rem; }
  
  /* Consolidados: chips e sobrescrito */
  #exec-summary .idchips{ display:flex; flex-wrap:wrap; gap:6px }
  #exec-summary .idchips .chip{ font-size:11px; }
  #exec-summary table.mini th sup{ font-size:10px; }
  #exec-summary table.mini th sub{ font-size:10px; }




</style>
</head>
<body>
<button id="showLeft">Mostrar filtros</button>

<div class="app" id="appGrid">

  <!-- ESQUERDA (sempre visível) -->
  <section class="card left" id="leftPanel">
    <div class="head">
      <h3>Estudo de Caso</h3>
      <!-- botão esconder removido -->
      <span></span>
    </div>

    <!-- escala do painel esquerdo -->
    <!--div class="grid-row" style="display:flex;align-items:center;gap:.5rem">
      <label for="uiScaleL" class="muted" style="min-width:120px"><small>Tam. texto</small></label>
      <input id="uiScaleL" type="range" min="80" max="120" value="80" step="5" style="width:160px">
      <span id="uiScaleLVal" class="muted">80%</span>
    </div-->

    <div class="grid-row">
      <select id="caseSelect"></select>
    </div>
    <div class="grid-row muted">Execuções disponíveis</div>
    <div class="scroll" id="runsList" style="padding:10px 12px;"></div>
    <div class="grid-row muted" style="font-size:12px">
      Clique em <button class="btn small add">+</button> para adicionar a execução ao gráfico. Para efetuar o download do arquivo referente a execução clique em <a class="btn small">xlsx</a>.
    </div>
  </section>

  <!-- CENTRO -->
  <section class="card center">
    <div class="plot-top">
      <div class="muted" style="font-size:12px"><span style="display:inline-block;width:10px;height:10px;background:#ef4444;border-radius:50%;margin-right:6px;vertical-align:middle"></span>Eixo X inferior</div>
      <div class="grow"></div>
      <button id="btnUpdate" class="btn primary">Atualizar</button>
      <button id="btnClear" class="btn">Limpar</button>
	  <a id="varsBtn" class="btn ghost" href="./vars.html" target="_blank" rel="noopener">Descrição</a>
      <button class="collapse-btn" id="collapseRightToggle"><span id="rightTglText" class="muted">ocultar séries</span></button>
    </div>

    <div class="center-scroll">
      <div class="plot-wrap"><div id="plot"></div></div>


      <section id="exec-summary" class="subpanel">
        <details open>
      	<summary><strong>Consolidados de execuções</strong></summary>
      	<div class="row" style="margin:.25rem 0 0.5rem">
      	  <div>
      		<label for="consCase"><small>Estudo de Caso:</small></label>
      		<select id="consCase" style="min-width:180px"></select>
      	  </div>
      	</div>
      	<div id="consTable"></div>
        </details>
      </section>

	  
	  <section id="bat-requests" class="subpanel">
        <details open>
          <summary><strong>Chegadas de requisições de baterias</strong> (bat_request)</summary>
          <div class="row">
            <div>
              <label for="brScenario"><small>Cenário (ID###):</small></label>
              <select id="brScenario"></select>
            </div>
          </div>
          <div id="brChart" style="height: 240px; margin-top: .5rem;"></div>
          <div id="brTable" style="margin-top:.5rem;"></div>
        </details>
      </section>
    </div>
  </section>

  <!-- DIREITA (colapsável) -->
  <section class="card right" id="rightPanel">
    <div class="head">
      <h3>Séries do gráfico <span class="muted">— marque/desmarque para exibir</span></h3>
      <div style="display:flex;align-items:center;gap:8px">
        <!--div class="legend-help" id="helpTgl">?</div-->
        <button class="collapse-btn" id="collapseRight">esconder</button>
      </div>
    </div>

    <!-- escala do painel direito -->
    <!--div class="grid-row" style="display:flex;align-items:center;gap:.5rem">
      <label for="uiScaleR" class="muted" style="min-width:120px"><small>Tam. texto</small></label>
      <input id="uiScaleR" type="range" min="80" max="120" value="100" step="5" style="width:160px">
      <span id="uiScaleRVal" class="muted">100%</span>
    </div-->

	<div class="anchor-bar" id="varsAnchors">
	  <h3>Descrição das Variáveis:</h3>
	  <a href="vars.html#tempo-tarifas" target="_blank" rel="noopener">Tempo &amp; Tarifas</a>
	  <a href="vars.html#pv" target="_blank" rel="noopener">PV</a>
	  <a href="vars.html#fluxos" target="_blank" rel="noopener">Fluxos</a>
	  <a href="vars.html#custos" target="_blank" rel="noopener">Custos</a>
	  <a href="vars.html#demanda" target="_blank" rel="noopener">Demanda</a>
	  <a href="vars.html#controle" target="_blank" rel="noopener">Controle</a>
	  <a href="vars.html#slots" target="_blank" rel="noopener">Slots (0…12)</a>
	</div>

    <div class="scroll" id="seriesPanel" style="padding:10px 12px;"></div>
  </section>

</div>

<script>
const $ = s => document.querySelector(s);
const appGrid    = $('#appGrid');
const leftPanel  = $('#leftPanel');
const rightPanel = $('#rightPanel');
const runsList   = $('#runsList');
const caseSelect = $('#caseSelect');
const seriesPanel= $('#seriesPanel');
const showLeftBtn= $('#showLeft');
const rightTglText = $('#rightTglText');
const consCase  = document.getElementById('consCase');
const consTable = document.getElementById('consTable');

const CONS = { loaded:false, data:{} };

const ACTIVE = [];
const LOADED = {};
let INDEX = [];
let CASES = [];

// --------- escalas de fonte (fixo em 80%) ---------
leftPanel?.style.setProperty('--panel-scale', '0.80');
rightPanel?.style.setProperty('--panel-scale', '0.80');

/* --------- mapa cenário por ID --------- */
const SCENARIO_BY_ID = { "728":1, "330":2, "420":3, "179":4 }; // ordem 1..4

// Mapa "ID###" -> número do cenário (1..4)
const ID_TO_SCEN = {'ID728':1,'ID330':2,'ID420':3,'ID179':4};
function scenarioLabel(id){ return `Cenário ${ID_TO_SCEN[id] ?? '·'} (${id})`; }


const ALG_LABELS = {
  "MOEAD_H":"MOEA/D-H","MOEAD_C":"MOEA/D-C","NSGA2_PY":"NSGA2 PY",
  "MACO_PY":"MACO PY","MOEAD_PY":"MOEAD PY","NSPSO_PY":"NSPSO PY","PLIM":"PLIM",
};
//const FILE_RE = /^ID(?<id>\d+)_(?<alg>[A-Za-z0-9]+(?:_[A-Za-z0-9]+)*)_DF_P(?<P>[01])_RD(?<RD>[01])(?:_G(?<G>\d+))?(?:_(?<seed>\d{4,}))?\.xlsx$/i;

// aceita ..._G## (opcional), _seed (opcional), _RASP (opcional) e até timestamp antigo
const FILE_RE =
/^ID(?<id>\d+)_(?<alg>[A-Za-z0-9]+(?:_[A-Za-z0-9]+)*)_DF_P(?<P>[01])_RD(?<RD>[01])(?:_G(?<G>\d+))?(?:_(?<seed>\d{4,}))?(?:_(?<rasp>RASP))?\.xlsx$/i;


function parseFilenameMeta(name){
  const m = FILE_RE.exec(name.trim());
  if(!m) return null;
  const g = m.groups;
  const id   = Number(g.id);
  const P    = +g.P;
  const RD   = +g.RD;
  const G    = g.G ? +g.G : null;
  const seed = g.seed || null;
  const rasp = !!g.rasp;

  const algKey   = g.alg.toUpperCase();
  const algLabel = ALG_LABELS[algKey] || g.alg.replace(/_/g,'-');

  const base = `ID${id}_${algLabel}_P${P}_RD${RD}`;
  const tagG = G    ? `_G${G}`    : '';
  const tagR = rasp ? `_RASP`     : '';
  const tagS = seed ? ` — seed ${seed}` : ''; // seed só aparece como chip extra se existir

  return {
    id, P, RD, G, seed, rasp,
    algKey, algLabel, algRaw:g.alg,
    runKey : `ID${id}_${g.alg}_P${P}_RD${RD}${G?`_G${G}`:''}${seed?`_${seed}`:''}${rasp?`_RASP`:''}`,
    shortId: `${base}${tagG}${tagR}${tagS}`   // << formato compacto
  };
}




async function loadIndex(){
  const res = await fetch('index.json');
  const js = await res.json();
  INDEX = js.files||[];

  // estudos de caso
  CASES = Array.from(new Set(INDEX.map(f=>{
    const parts = (f.relpath||'').split('/');
    const i = parts.findIndex(p=>/^Estudo de Caso /.test(p));
    return i>=0? parts[i] : 'Estudo de Caso 1';
  }))).sort((a,b)=> (+a.replace(/\D+/g,''))-(+b.replace(/\D+/g,'')));
  caseSelect.innerHTML = CASES.map(c=>`<option>${c}</option>`).join('');

  prewarmBatRequests().finally(()=>{
    hydrateRuns();
    refreshBatRequestUI();
    const n = Number((caseSelect.value||CASES[0]).replace(/\D+/g,'')) || 1;
    if (n>=1 && n<=6) renderConsolidated(n);
  });

  // pré-aquecer bat_request: pega um arquivo por cenário (1..4), de qualquer estudo
  prewarmBatRequests().finally(()=>{
    hydrateRuns(); // monta lista do estudo selecionado
    refreshBatRequestUI(); // popula combo
  });
}

function groupAndSortRuns(runs){
  // agrupa por cenário (1..4) usando o ID → cenário do mapa
  const buckets = {1:[],2:[],3:[],4:[]};
  runs.forEach(f=>{
    const meta = parseFilenameMeta(f.name||'');
    if (!meta) return;
    const scen = SCENARIO_BY_ID[String(meta.id)];
    if (!scen) return;
    buckets[scen].push({file:f, meta});
  });
  // ordena internamente por P, RD, G, seed
  for (const k of [1,2,3,4]){
    buckets[k].sort((a,b)=>{
      return (a.meta.P-b.meta.P)|| (a.meta.RD-b.meta.RD) || ((a.meta.G||0)-(b.meta.G||0)) || String(a.meta.seed||'').localeCompare(String(b.meta.seed||''));
    });
  }
  return buckets;
}

function hydrateRuns(){
  const sel = caseSelect.value||CASES[0];
  const runs = INDEX.filter(f => (f.relpath||'').includes(`/${sel}/`));
  const buckets = groupAndSortRuns(runs);

  runsList.innerHTML = '';
  for (const scen of [1,2,3,4]){
    const arr = buckets[scen];
    if (!arr.length) continue;
    // cabeçalho de cenário
    const hdr = document.createElement('div');
    hdr.className = 'muted'; hdr.style.cssText = 'font-weight:700;margin:6px 0;';
    hdr.textContent = `Cenário ${scen}`;
    runsList.appendChild(hdr);

    arr.forEach(({file, meta})=>{
      const row = document.createElement('div');
      row.className='run';
      row.innerHTML = `
        <div style="min-width:0">
          <div class="title">ID${meta.id}</div>
          <div class="chips">
            <span class="chip">${meta.algLabel}</span>
            <span class="chip">P${meta.P}</span>
            <span class="chip">RD${meta.RD}</span>
            ${meta.G?`<span class="chip">G${meta.G}</span>`:''}
            ${meta.seed?`<span class="chip">seed ${meta.seed}</span>`:''}
			${meta.rasp?`<span class="chip">RASP</span>`:''}
          </div>
        </div>
        <div class="actions">
          <a class="btn small" href="${file.url}" target="_blank">xlsx</a>
          <button class="btn small add">+</button>
        </div>`;
      row.querySelector('button.add').onclick = ()=> addRun({file, meta});
      runsList.appendChild(row);
    });
  }
}

async function loadXlsx(url){
  if(LOADED[url]) return LOADED[url];
  const r = await fetch(url);
  const ab = await r.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(sheet,{defval:null});
  const cols = new Set(Object.keys(data[0]||{}));
  LOADED[url] = {data, cols};
  return LOADED[url];
}

function isMonetary(col){
  return /^cost|^rev/i.test(col) || /_cost$|_total$|_period$|_period_total/i.test(col);
}

/* --------- exclusões de séries no checkbox --------- */
const SERIES_EXCLUDE = new Set(['period','Hora','bat_request','swaps_end_queue','swap_denied']);

async function addRun({file, meta}){
  const {data, cols} = await loadXlsx(file.url);
  const block = document.createElement('div');
  block.className='series-block';
  block.dataset.url = file.url;
  const filterId = 'flt_'+Math.random().toString(36).slice(2);
  block.innerHTML = `
    <div class="series-head">
      <div class="id" title="${meta.shortId}">${meta.shortId}</div>
      <input id="${filterId}" type="text" placeholder="filtrar colunas…"/>
    </div>
    <div class="series-list"></div>`;
  seriesPanel.appendChild(block);

  const list = block.querySelector('.series-list');
  const arr = Array.from(cols).filter(c => !SERIES_EXCLUDE.has(c)); // sem sort()
  const defaults = new Set(['E_virtual','e_Resultant','Cost_Period_Total']);

  arr.forEach(col=>{
    const li = document.createElement('label');
    li.className='series-item'; li.title=col;
    li.innerHTML = `<input type="checkbox" data-col="${col}"> <span>${col}</span>`;
    const cb = li.querySelector('input');
    if(defaults.has(col)) cb.checked = true;
    cb.addEventListener('change', draw);
    list.appendChild(li);
  });

  block.querySelector('#'+filterId).addEventListener('input', e=>{
    const q = e.target.value.toLowerCase();
    list.querySelectorAll('.series-item').forEach(i=>{
      i.style.display = i.title.toLowerCase().includes(q)?'':'none';
    });
  });

  ACTIVE.push({meta, file, data, cols:arr, block});

  // registra bat_request deste cenário (apenas 1x por ID)
  registerBatRequest(meta, data);
  refreshBatRequestUI();

  draw();
}

/* --------- seleção de séries --------- */
function selectedSeries(){
  const groups=[];
  ACTIVE.forEach(run=>{
    const cols = Array.from(run.block.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.dataset.col);
    if(cols.length) groups.push({run, cols});
  });
  return groups;
}

function hourTicks(){
  const ticks=[], labs=[];
  for(let h=0; h<24; h++){
    ticks.push(1+h*4); labs.push(String(h).padStart(2,'0')+':00');
  }
  return {ticks, labs};
}


function draw(){
  const traces=[];
  const xField='period'; // fixo
  const {ticks,labs}=hourTicks();
  const first = new Map();

  // --- traço "fantasma" só para garantir xaxis2 visível ---
  traces.push({
    x: ticks,
    y: ticks.map(()=>0),    // não influencia visualmente (linha opaca 0)
    mode: 'lines',
    line: { width: 0 },
    hoverinfo: 'skip',
    showlegend: false,
    opacity: 0,
    xaxis: 'x2',            // força a renderização do eixo superior
    yaxis: 'y'
  });

  // --- séries reais ---
  selectedSeries().forEach(({run, cols})=>{
    const X = run.data.map(r=> Number(r[xField]));
    cols.forEach(col=>{
      const isFirst = !first.has(run.meta.shortId);
      first.set(run.meta.shortId,true);
      traces.push({
        x: X,
        y: run.data.map(r=> r[col]==null? null : Number(r[col])),
        mode: 'lines',
        name: col,
        legendgroup: run.meta.shortId,
        ...(isFirst? { legendgrouptitle:{ text: run.meta.shortId } } : {}),
        yaxis: isMonetary(col) ? 'y2' : 'y1',
        hovertemplate: '%{y}<extra></extra>'
      });
    });
  });

  Plotly.newPlot('plot', traces, {
    margin:{l:60,r:60,t:76,b:50},  // top maior pros rótulos de Hora

    // eixo inferior (period)
    xaxis:{
      title:{ text:'period', font:{ size:12 } },
      tickmode:'linear', dtick:4,
      tickfont:{ size:11 },
      zeroline:false, showgrid:true, gridcolor:'#f1f5f9',
      showspikes:true, spikemode:'across', spikethickness:1, spikesnap:'cursor'
    },

    // eixo superior (Hora) — inclinado para a direita (+45°)
	xaxis2:{
	  overlaying:'x', side:'top', anchor:'y', layer:'above traces',
	  tickvals: ticks, ticktext: labs,
	  tickangle: -45,                  // ⇠ aqui! inclinando “/”
	  ticklabelposition:'outside top',
	  tickfont:{ size:10 },
	  ticks:'outside',
	  showticklabels:true,
	  automargin:true,
	  showgrid:false, zeroline:false,
	  title:{ text:'Hora', standoff:6, font:{ size:11 } }
	},


    yaxis:{ title:'kWh / kW / contagem', zeroline:false, gridcolor:'#eef2f7', tickfont:{ size:11 } },
    yaxis2:{ title:'R$', overlaying:'y', side:'right', zeroline:false, gridcolor:'#eef2f7', tickfont:{ size:11 } },

    legend:{ orientation:'h', x:0, y:-0.2, font:{ size:11 } },

    hovermode:'x unified',
    hoverlabel:{ bgcolor:'#fff', bordercolor:'#e5e7eb', font:{ size:12 } },

    paper_bgcolor:'#fff', plot_bgcolor:'#fff',
    font:{ size:12 } // fonte base do gráfico
  }, { displaylogo:false, responsive:true });
}




function resizePlot(){
  const el = document.getElementById('plot');
  if(el){ Plotly.Plots.resize(el); setTimeout(()=>Plotly.Plots.resize(el), 60); }
}

/* --------- painel bat_request --------- */
const batReqByScenario = new Map(); // Map<ID###, Array(96) {SoE,SoC,Qty}>
const brScenario = document.getElementById('brScenario');
const brChartEl  = document.getElementById('brChart');
const brTableEl  = document.getElementById('brTable');

function parseBatRequest(val){
  if (val == null) return {SoE:[], SoC:[], Qty:0};
  if (typeof val === 'object') {
    const {SoE=[], SoC=[], Qty=0} = val;
    return {SoE, SoC, Qty: Number(Qty)||0};
  }
  let s = String(val).trim();
  if (!s || s === 'null' || s === 'undefined') return {SoE:[], SoC:[], Qty:0};
  try {
    s = s.replaceAll("'", '"');
    const obj = JSON.parse(s);
    const {SoE=[], SoC=[], Qty=0} = obj||{};
    return {SoE, SoC, Qty: Number(Qty)||0};
  } catch {
    return {SoE:[], SoC:[], Qty:0};
  }
}

function registerBatRequest(meta, rows){
  const id = `ID${meta.id}`;
  if (batReqByScenario.has(id)) return; // igual para o cenário
  const arr = Array(96).fill(0).map(()=>({SoE:[],SoC:[],Qty:0}));
  for (const r of rows) {
    const p = Number(r.period)||0;
    if (p>=1 && p<=96) arr[p-1] = parseBatRequest(r.bat_request);
  }
  batReqByScenario.set(id, arr);
}

function refreshBatRequestUI(selectedId){
  // preserva seleção atual (quando existir)
  let want = selectedId || (brScenario ? brScenario.value : null);

  // repopula o combo na ordem 1..4 com rótulos "Cenário N (ID###)"
  if (brScenario){
    brScenario.innerHTML = '';
    for (const id of ['ID728','ID330','ID420','ID179']){
      if (batReqByScenario.has(id)){
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = scenarioLabel(id);
        brScenario.appendChild(opt);
      }
    }
    if (want && [...brScenario.options].some(o=>o.value===want)) {
      brScenario.value = want;
    }
  }

  const id = brScenario?.value || [...batReqByScenario.keys()][0];
  if (!id) return;

  const data = batReqByScenario.get(id) || [];
  const qty  = data.map(d => d?.Qty || 0);

  // gráfico de barras
  if (brChartEl){
    Plotly.newPlot(brChartEl, [{
      type:'bar', x: Array.from({length:96}, (_,i)=> i+1), y: qty, name:'Qty'
    }], {
      margin:{l:40,r:10,t:20,b:40},
      xaxis:{ title:'period', tickmode:'linear', dtick:4, zeroline:false },
      yaxis:{ title:'Qty', rangemode:'nonnegative', dtick:1, zeroline:false },
      showlegend:false
    }, {displaylogo:false, responsive:true});
  }

  // tabela (apenas períodos com Qty>0)
  if (brTableEl){
    const to2 = v => (v==null || v==='') ? '' : Number(v).toFixed(2);
    const fmtArr = arr => (arr||[]).map(to2).join(', ');

    const rows = [];
    data.forEach((d, i)=>{
      if ((d?.Qty||0)>0){
        rows.push(`<tr>
          <td>${i+1}</td>
          <td>${d.Qty}</td>
          <td>${fmtArr(d.SoE)}</td>
          <td>${fmtArr(d.SoC)}</td>
        </tr>`);
      }
    });
    brTableEl.innerHTML = `
      <table class="mini">
        <thead><tr><th>period</th><th>Qty</th><th>SoE (kWh)</th><th>SoC(%)</th></tr></thead>
        <tbody>${rows.join('') || `<tr><td colspan="4"><em>Nenhuma chegada (Qty=0)</em></td></tr>`}</tbody>
      </table>`;
  }
}
brScenario?.addEventListener('change', (e)=> refreshBatRequestUI(e.target.value));


function firstVal(obj, keys){
  for (const k of keys){
    if (Object.prototype.hasOwnProperty.call(obj, k)){
      const v = obj[k];
      if (v !== undefined && v !== null && v !== '') return v;
    }
  }
  return null;
}

function subLabel(s){
  if(!s) return '';
  const i = s.indexOf('_');
  if(i === -1) return s;
  return s.slice(0,i) + '<sub>' + s.slice(i+1) + '</sub>';
}


function idChips(meta){
  return `<div class="idchips">
    <span class="chip">Cenário ${meta.scen}</span>
    <span class="chip">${meta.idTok}</span>
    <span class="chip">${meta.algLabel}</span>
    <span class="chip">P${meta.P}</span>
    ${meta.G ? `<span class="chip">G${meta.G}</span>` : ''}
    <span class="chip">RD${meta.RD}</span>
    ${meta.rasp ? `<span class="chip">RASP</span>` : ''}
  </div>`;
}


function parseRowForIdent(row, caseNum){
  const idRaw = firstVal(row, ['BSS_ID','ID','BSS Id']) || '';
  const idNum = String(idRaw).replace(/\D/g,'');     // "179"
  const idTok = 'ID' + idNum;                        // "ID179"
  const scen  = SCENARIO_BY_ID[idNum] ?? 999;

  const algRaw   = firstVal(row, ['Algoritmo','ALG','Alg']) || '';
  const algLabel = ALG_LABELS[String(algRaw).toUpperCase()] || String(algRaw).replace(/_/g,'-');
  const P        = Number(firstVal(row, ['Preditivo','P#','P'])) ? 1 : 0;
  const G        = String(firstVal(row, ['Gerações','Geracoes','G#','G']) || '').replace(/\D/g,'');
  const RD       = (String(firstVal(row, ['RD','RD#']) || '0').replace(/\D/g,'')) || 0;

  const rasp     = rowIsRASP(row, caseNum, idNum, algRaw, P, RD, G);

  return {idNum:+idNum, idTok, scen:+scen, algLabel, P, G, RD, rasp};
}

function getQueryParams(){
  const q = new URLSearchParams(location.search);
  const runs = [];
  q.getAll('run').forEach(v=>{ if(v) runs.push(v) });
  (q.get('runs')||'').split(/[;,]/).forEach(v=>{ v=v.trim(); if(v) runs.push(v) });
  return {
    case: q.get('case') || q.get('caso') || q.get('study'),
    id  : q.get('id'),
    alg : q.get('alg'),
    p   : q.get('p'),
    rd  : q.get('rd'),
    g   : q.get('g'),
    rasp: q.get('rasp'),
    runs
  };
}

// aceita strings tipo: ID330_MOEAD_H_DF_P1_RD0_G20_RASP (ordem flexível de DF / RASP / SEED)
function parseRunSpecStr(s){
  if(!s) return null;
  const S = s.toUpperCase().replace(/\.(XLSX)$/i,'').replace(/-+/g,'_');
  const re = /^ID(?<id>\d+)_(?<alg>[A-Z0-9_]+?)(?:_DF)?_P(?<P>[01])_RD(?<RD>[01])(?:_G(?<G>\d+))?(?:_(?<tag1>RASP|SEED\d+))?(?:_(?<tag2>RASP|SEED\d+))?$/;
  const m = re.exec(S);
  if(!m) return null;
  const g = m.groups;
  const spec = { id:+g.id, alg:g.alg, P:+g.P, RD:+g.RD };
  if(g.G) spec.G = +g.G;
  const tags = [g.tag1,g.tag2].filter(Boolean);
  spec.rasp = tags.includes('RASP');
  return spec;
}

function algEq(a,b){ return String(a||'').toUpperCase()===String(b||'').toUpperCase(); }

function findRunFileBySpec(spec, caseNum){
  const label = caseNum ? `Estudo de Caso ${caseNum}` : null;
  const pool = INDEX.filter(f => !label || (f.relpath||'').includes(`/${label}/`));
  for(const f of pool){
    const meta = parseFilenameMeta(f.name||'');
    if(!meta) continue;
    if(spec.id!=null && +spec.id !== meta.id) continue;
    if(spec.alg    && !algEq(spec.alg, meta.algRaw)) continue;
    if(spec.P !=null && +spec.P  !== meta.P)  continue;
    if(spec.RD!=null && +spec.RD !== meta.RD) continue;
    if(spec.G !=null && (+spec.G) !== (meta.G||0)) continue; // exige igualdade se G especificado
    if(typeof spec.rasp==='boolean' && spec.rasp!==!!meta.rasp) continue;
    return f;
  }
  return null;
}


async function applyDeepLink(){
  const q = getQueryParams();

  // 1) selecionar Estudo de Caso
  let caseNum = null;
  if(q.case){
    caseNum = Number(String(q.case).replace(/\D/g,'')) || null;
    if(caseNum){
      const label = `Estudo de Caso ${caseNum}`;
      if(CASES.includes(label)) caseSelect.value = label;
      hydrateRuns();
    }
  }

  // 2) montar specs a partir de ?run= / ?runs= ou dos tokens (?id&alg&p&rd&g&rasp)
  const wanted = [];
  if(q.id && q.alg){
    wanted.push({
      id:+q.id, alg:q.alg, P:+(q.p??0), RD:+(q.rd??0),
      G: q.g? +q.g : undefined,
      rasp: q.rasp ? /^(1|true|sim|rasp)$/i.test(q.rasp) : undefined
    });
  }
  q.runs.forEach(s=>{ const sp = parseRunSpecStr(s); if(sp) wanted.push(sp); });

  // 3) localizar cada arquivo e adicionar ao gráfico
  const seen = new Set();
  for(const spec of wanted){
    const key = JSON.stringify(spec);
    if(seen.has(key)) continue;
    seen.add(key);
    const file = findRunFileBySpec(spec, caseNum);
    if(file){
      const meta = parseFilenameMeta(file.name);
      await addRun({file, meta});
    }
  }
  if(wanted.length) draw();
}





async function loadConsolidatedWB(){
  if (CONS.loaded) return CONS;
  try{
    const r = await fetch('Consolidados.xlsx');
    const ab = await r.arrayBuffer();
    const wb = XLSX.read(ab, {type:'array'});
    ['Caso_1','Caso_2','Caso_3','Caso_4','Caso_5','Caso_6'].forEach(s=>{
      if (wb.Sheets[s]) CONS.data[s] = XLSX.utils.sheet_to_json(wb.Sheets[s], {defval:null});
    });
    CONS.loaded = true;
  }catch(e){
    CONS.loaded = true;
    CONS.error = e;
    console.warn('Falha ao carregar Consolidados.xlsx', e);
  }
  return CONS;
}

function rowIsRASP(row, caseNum, idNum, algRaw, P, RD, G){
  // 1) valor explícito na planilha
  const flag = firstVal(row, ['Rasp','RASP','rasp','Execução','Execucao','Exec']);
  if (flag !== null){
    const s = String(flag).trim().toLowerCase();
    // aceita 1/0, true/false, sim/não e "rasp"
    if (s === '1' || s === 'true' || s === 'sim' || s === 'rasp') return true;
    if (s === '0' || s === 'false' || s === 'nao' || s === 'não' || s === '' ) return false;
    // fallback numérico
    if (!isNaN(Number(s))) return Number(s) !== 0;
  }
  // 2) fallback: para Caso 6, se existir arquivo _RASP correspondente
  if (caseNum === 6){
    return !!hasRASP(idNum, algRaw, P, RD, G);
  }
  return false;
}



// procura no index.json se existe arquivo com _RASP que case com a execução
function hasRASP(id, alg, P, RD, G){
  const algToken = String(alg||'').toUpperCase().replace(/[^A-Z0-9_]/g,'');
  const gPart = G ? `_G${G}` : '';
  const re = new RegExp(`^ID${id}_${algToken}_DF_P${P}_RD${RD}${gPart}_RASP`, 'i');
  return (INDEX||[]).some(f => re.test(f.name||''));
}

function buildIdent(row, caseNum){
  const idRaw = firstVal(row, ['BSS_ID','ID','BSS Id']) || '';
  const idNum = String(idRaw).replace(/\D/g,'');         // ex.: "179"
  const idTok = 'ID' + idNum;                            // "ID179"

  const scen = SCENARIO_BY_ID[idNum] ?? '·';

  const algRaw   = firstVal(row, ['Algoritmo','ALG','Alg']) || '';
  const algLabel = ALG_LABELS[String(algRaw).toUpperCase()] || String(algRaw).replace(/_/g,'-');

  const pRaw = firstVal(row, ['Preditivo','P#','P']);
  const P    = Number(pRaw) ? 1 : 0;

  const gRaw = firstVal(row, ['Gerações','Geracoes','G#','G']) || '';
  const G    = String(gRaw).replace(/\D/g,'');

  const rdRaw = firstVal(row, ['RD','RD#']) || '0';
  const RD    = String(rdRaw).replace(/\D/g,'') || 0;

  const rasp  = (caseNum===6 && hasRASP(idNum, algRaw, P, RD, G)) ? ' — RASP' : '';
  const gPart = G ? ` — G${G}` : '';

  return `Cenário ${scen} — ${idTok} — ${algLabel} — P${P}${gPart} — RD${RD}${rasp}`;
}


function renderConsolidated(caseNum){
  loadConsolidatedWB().then(()=>{
    // popular o combo (1..6) uma única vez
    if (consCase && !consCase.options.length){
      const opts = [];
      for (let n=1;n<=6;n++){
        if (CONS.data[`Caso_${n}`]) opts.push(`<option value="${n}">Estudo de Caso ${n}</option>`);
      }
      consCase.innerHTML = opts.join('');
    }
    if (consCase) consCase.value = String(caseNum);

    const raw = CONS.data[`Caso_${caseNum}`] || [];

    // enrich + ordenar por cenário (1..4) e, de quebra, por ID
    const rows = raw.map(r => ({ r, meta: parseRowForIdent(r, caseNum) }))
                    .sort((a,b)=> (a.meta.scen - b.meta.scen) || (a.meta.idNum - b.meta.idNum));

    const headers = ['Execução','Tempo','C_Total','R_Bruta','Uso Solar','FAC_Solar','ICR_Solar','BVE','TX_ocup','TX_atend','Swaps','Negações'];

    const to2 = v => (v==null || v==='') ? '' : Number(v).toFixed(2);
    const toI = v => (v==null || v==='') ? '' : Math.round(Number(v));

    const htmlRows = rows.map(({r, meta})=>{
      const tempo = firstVal(r, ['Tempo']);
      const ctot  = firstVal(r, ['Custo_Total','C_Total']);
      const rbru  = firstVal(r, ['Receita_Bruta','R_Bruta']);
      const uso   = firstVal(r, ['Uso_Solar','Uso Solar']);
      const fac   = firstVal(r, ['FAC_Solar_%','FAC Solar %']);
      const icr   = firstVal(r, ['ICR_Solar_%','ICR Solar %']);
      const bve   = firstVal(r, ['BEV_kWh','BVE','BVE_kWh']);
      const txo   = firstVal(r, ['TX_Ocupacao_%','TX Ocupação %','TX_Ocupação_%','TX Ocupacao %']);
      const txa   = firstVal(r, ['QoS_%','TX_atend','TX_atendimento_%']);
      const swaps = firstVal(r, ['swap_ocorridas','Swaps']);
      const neg   = firstVal(r, ['swap_penalty_ocorridas','Negações','Negacoes']);

      return `<tr>
        <td>${idChips(meta)}</td>
        <td>${tempo == null ? '' : tempo}</td>
        <td>${to2(ctot)}</td>
        <td>${to2(rbru)}</td>
        <td>${to2(uso)}</td>
        <td>${to2(fac)}</td>
        <td>${to2(icr)}</td>
        <td>${to2(bve)}</td>
        <td>${to2(txo)}</td>
        <td>${to2(txa)}</td>
        <td>${toI(swaps)}</td>
        <td>${toI(neg)}</td>
      </tr>`;
    }).join('');

	const headHtml = headers.map(h=>`<th>${subLabel(h)}</th>`).join('');


    consTable.innerHTML = `
      <table class="mini">
        <thead><tr>${headHtml}</tr></thead>
        <tbody>${htmlRows || `<tr><td colspan="${headers.length}"><em>Sem dados para este estudo.</em></td></tr>`}</tbody>
      </table>`;
  });
}



// mudar o caso via combo próprio
consCase?.addEventListener('change', e => renderConsolidated(Number(e.target.value)));



/* --------- pré-aquecimento de bat_request (um arquivo por cenário) --------- */
async function prewarmBatRequests(){
  // encontra um arquivo por ID alvo (728,330,420,179) em qualquer estudo
  const wanted = ['728','330','420','179']; // ordem 1..4
  for (const id of wanted){
    const f = INDEX.find(x => /^ID\d+_/i.test(x.name||'') && (x.name||'').includes(`ID${id}_`));
    if (!f) continue;
    try{
      const {data} = await loadXlsx(f.url);
      const fakeMeta = {id:Number(id)};
      registerBatRequest(fakeMeta, data);
    }catch(e){ console.warn('prewarm falhou', id, e); }
  }
}

/* --------- Controles --------- */
document.getElementById('btnUpdate').onclick = draw;
document.getElementById('btnClear').onclick = ()=>{
  ACTIVE.splice(0,ACTIVE.length);
  seriesPanel.innerHTML='';
  draw();
};

document.getElementById('collapseRight').onclick = ()=>{
  rightPanel.classList.add('collapsed');
  rightTglText.textContent='mostrar séries';
  syncGridClasses();
};
document.getElementById('collapseRightToggle').onclick = ()=>{
  const willShow = rightPanel.classList.contains('collapsed');
  rightPanel.classList.toggle('collapsed');
  rightTglText.textContent = willShow ? 'ocultar séries' : 'mostrar séries';
  syncGridClasses();
};


function syncGridClasses(){
  appGrid.classList.toggle('left-collapsed',  leftPanel.classList.contains('collapsed')); // sempre falso
  appGrid.classList.toggle('right-collapsed', rightPanel.classList.contains('collapsed'));
  resizePlot();
}

window.addEventListener('resize', ()=>{ resizePlot(); if (brChartEl) Plotly.Plots.resize(brChartEl); });

caseSelect.onchange = ()=>{
  hydrateRuns();
  refreshBatRequestUI();
  const n = Number(caseSelect.value.replace(/\D+/g,'')) || 1;
  if (n>=1 && n<=6) renderConsolidated(n);
};


loadIndex()
  .then(() => applyDeepLink())
  .catch(err => {
    console.error(err);
    runsList.innerHTML = `<div class="muted">Erro ao carregar o índice.</div>`;
  });

try{
  if(!localStorage.getItem('vars_opened_once')){
    // tenta abrir em segundo plano; alguns navegadores podem bloquear
    window.open('vars.html','_blank','noopener');
    localStorage.setItem('vars_opened_once','1');
  }
}catch(e){}

</script>
</body>
</html>
