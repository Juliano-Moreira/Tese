<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Selecionar & Visualizar (BSS)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>
<style>
  :root { --sidebar-w: 340px; --gap: 12px; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial; }
  .layout { display:grid; grid-template-columns: var(--sidebar-w) 1fr; min-height:100vh; }
  .sidebar { padding:14px; border-right:1px solid #e5e7eb; background:#fafafa; }
  .sidebar h1 { margin:0 0 10px; font-size:18px; }
  .field { margin-bottom:10px; }
  .field label { display:block; font-size:12px; color:#374151; margin-bottom:4px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  select, button, input[type="text"] {
    width:100%; padding:8px; font-size:14px; border:1px solid #d1d5db; border-radius:6px; background:#fff;
  }
  button.primary { background:#111827; color:#fff; border-color:#111827; }
  button.ghost { background:#fff; }
  .chip { font-size:12px; background:#eef2ff; border:1px solid #c7d2fe; color:#111827;
          border-radius:6px; padding:8px; word-break:break-all; display:none; }
  .chip.ok{ background:#ecfdf5; border-color:#a7f3d0; }
  .chip.bad{ background:#fef2f2; border-color:#fecaca; }
  .muted { color:#6b7280; font-size:12px; }
  .content { padding:16px; display:flex; flex-direction:column; gap:var(--gap); }
  #colControls { display:grid; grid-template-columns: 220px 1fr auto auto; gap:var(--gap); align-items:end; }
  #yList { height:120px; overflow:auto; border:1px solid #e5e7eb; border-radius:6px; padding:6px; background:#fff; }
  #yList .opt { display:flex; gap:8px; align-items:center; padding:2px 0; }
  #chart { width:100%; height:70vh; border:1px solid #e5e7eb; border-radius:8px; }
  @media (max-width:1000px){
    .layout { grid-template-columns: 1fr; }
    .sidebar { border-right:none; border-bottom:1px solid #e5e7eb; }
    #colControls { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="layout">
  <aside class="sidebar">
    <h1>Selecionar arquivo</h1>
    <div class="field">
      <label for="caseSel">Estudo de Caso</label>
      <select id="caseSel"></select>
    </div>

    <div class="field">
      <label for="scnSel">Cenário (BSS)</label>
      <select id="scnSel">
        <option value="1">1 — BSS 728</option>
        <option value="2">2 — BSS 330</option>
        <option value="3">3 — BSS 420</option>
        <option value="4">4 — BSS 179</option>
      </select>
    </div>

    <div class="field">
      <label for="algSel">Algoritmo</label>
      <select id="algSel">
        <option>MOEAD_H</option>
        <option>MOEAD_C</option>
        <option>moead_PY</option>
        <option>maco_PY</option>
        <option>nspso_PY</option>
        <option>nsga2_PY</option>
        <option>PLIM</option>
      </select>
    </div>

    <div class="field row">
      <div>
        <label for="pSel">P (modo)</label>
        <select id="pSel">
          <option value="1">P1 — Preditivo</option>
          <option value="0">P0 — Reativo</option>
        </select>
      </div>
      <div>
        <label for="rdSel">RD</label>
        <select id="rdSel">
          <option value="1">RD1 — habilitado</option>
          <option value="0">RD0 — desabilitado</option>
        </select>
      </div>
    </div>

    <div class="field">
      <button id="btnFind" class="primary">Procurar arquivo</button>
    </div>
    <div id="matchBox" class="chip"></div>

    <p class="muted">DF é fixo no nome. Se houver múltiplos, escolhemos o mais recente (pelo timestamp no nome).</p>
  </aside>

  <main class="content">
    <div id="colControls">
      <div>
        <label for="xSel">Coluna X (eixo)</label>
        <select id="xSel"></select>
      </div>
      <div>
        <label>Séries Y (marque para exibir)</label>
        <div id="yList"></div>
      </div>
      <button id="btnPlot" class="primary">Atualizar gráfico</button>
      <button id="btnClear" class="ghost">Limpar</button>
    </div>

    <div id="chart"></div>
    <div class="muted" id="hint">Dica: normalmente use <b>period</b> no eixo X e selecione, por exemplo, <b>E_virtual</b>, <b>Cost_Period</b>, etc.</div>
  </main>
</div>

<script>
(async function(){
  // --------- CONFIG ---------
  const INDEX_JSON_URL = './index.json';      // relative to this file
  const BSS_OF = { '1':728, '2':330, '3':420, '4':179 };

  // --------- LOAD INDEX.JSON ---------
  const idx = await (await fetch(INDEX_JSON_URL)).json();

  // montar lista de "Estudo de Caso N" a partir das pastas
  const caseSet = new Set(
    idx.files.map(f=>{
      const m = (f.folder||'').match(/Resultados\/Estudo de Caso (\d+)\/Resultado Final/i);
      return m ? `Estudo de Caso ${m[1]}` : null;
    }).filter(Boolean)
  );
  const cases = Array.from(caseSet).sort((a,b)=>(parseInt(a.replace(/\D+/g,''))||0)-(parseInt(b.replace(/\D+/g,''))||0));
  const caseSel = document.getElementById('caseSel');
  cases.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; caseSel.appendChild(o); });

  // --------- ELEMENTS ---------
  const scnSel  = document.getElementById('scnSel');
  const algSel  = document.getElementById('algSel');
  const pSel    = document.getElementById('pSel');
  const rdSel   = document.getElementById('rdSel');
  const btnFind = document.getElementById('btnFind');
  const matchBox= document.getElementById('matchBox');

  const xSel    = document.getElementById('xSel');
  const yList   = document.getElementById('yList');
  const btnPlot = document.getElementById('btnPlot');
  const btnClear= document.getElementById('btnClear');
  const chartDiv= document.getElementById('chart');

  let current = { file:null, data:[], columns:[] };

  // --------- HELPERS ---------
  function candidates(caseLabel, scn, alg, p, rd){
    const n = (caseLabel.match(/\d+/)||[])[0];
    if(!n) return [];
    const folderRe = new RegExp(`Resultados\\/Estudo de Caso ${n}\\/Resultado Final`,'i');
    const bss = BSS_OF[String(scn)];
    const pat = new RegExp(`^ID${bss}_${alg}_DF_P${p}_RD${rd}_.+\\.xlsx$`, 'i');
    return idx.files.filter(f => folderRe.test(f.folder||'') && pat.test(f.name||''));
  }
  function parseTs(name){
    const m = name.match(/_(\d{4}-\d{2}-\d{2})_(\d{2}-\d{2}-\d{2})\.xlsx$/i);
    return m ? Date.parse(m[1]+'T'+m[2].replace(/-/g,':')+'Z')||0 : 0;
  }
  function pickLatest(files){
    return files.map(f=>({f,t:parseTs(f.name)})).sort((a,b)=>b.t-a.t)[0]?.f || null;
  }
  function fileUrl(entry){
    // preferir entry.url; senão, usar relpath ou folder/name
    if (entry.url) return entry.url;
    if (entry.relpath) return entry.relpath;
    return ((entry.folder? entry.folder + '/' : '') + entry.name);
  }
  function showMsg(msg, ok){
    matchBox.style.display='block';
    matchBox.classList.toggle('ok', !!ok);
    matchBox.classList.toggle('bad', !ok);
    matchBox.textContent = msg;
  }
  function toNumber(v){
    if (typeof v === 'number') return v;
    if (typeof v === 'string'){
      let s = v.trim();
      if (s === '') return null;
      // tenta parse direto
      let n = Number(s);
      if (Number.isFinite(n)) return n;
      // troca vírgula por ponto
      n = Number(s.replace(',', '.'));
      if (Number.isFinite(n)) return n;
    }
    return null;
  }
  function inferNumericColumns(rows){
    if (!rows.length) return [];
    const names = Object.keys(rows[0]);
    return names.filter(c=>{
      let cnt=0, ok=0;
      for (let i=0;i<Math.min(rows.length, 80);i++){
        const v = rows[i][c];
        if (v==null || v==='') continue;
        cnt++;
        if (toNumber(v) !== null) ok++;
      }
      return cnt>0 && ok/cnt > 0.8; // 80% numérico
    });
  }

  async function loadXlsx(url){
    const ab = await (await fetch(url)).arrayBuffer();
    const wb = XLSX.read(ab, { type:'array' });
    const wsname = wb.SheetNames[0];
    const sheet = wb.Sheets[wsname];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval:null });
    return rows;
  }

  function fillColumnSelectors(columns){
    // X: prioriza 'period' se existir, senão primeira numérica
    xSel.innerHTML = '';
    columns.forEach(c=>{
      const opt = document.createElement('option');
      opt.value=c; opt.textContent=c;
      xSel.appendChild(opt);
    });
    const ix = columns.indexOf('period');
    xSel.value = (ix>=0? 'period' : columns[0]||'');

    // Y checkboxes
    yList.innerHTML = '';
    columns.forEach(c=>{
      if (c===xSel.value) return; // não marcar X por padrão
      const div = document.createElement('div');
      div.className='opt';
      const cb = document.createElement('input');
      cb.type='checkbox'; cb.value=c;
      // marcas padrão que fazem sentido em muitos casos
      if (['E_virtual','Cost_Period','q_arrived','cumulative_swaps'].includes(c)) cb.checked=true;
      const lb = document.createElement('label');
      lb.textContent = c; lb.style.cursor='pointer';
      lb.addEventListener('click', ()=>{ cb.checked=!cb.checked; });
      div.appendChild(cb); div.appendChild(lb);
      yList.appendChild(div);
    });
  }

  function gatherYSelected(){
    return Array.from(yList.querySelectorAll('input[type=checkbox]'))
                .filter(cb=>cb.checked).map(cb=>cb.value);
  }

  function plot(){
    if (!current.data.length) return;
    const xCol = xSel.value;
    const yCols = gatherYSelected();
    if (!xCol || !yCols.length){
      showMsg('Selecione a coluna X e ao menos uma série Y.', false);
      return;
    }
    const rows = current.data;
    const x = rows.map(r=>toNumber(r[xCol]));
    const traces = yCols.map(col=>{
      const y = rows.map(r=>toNumber(r[col]));
      return {
        x, y,
        mode: 'lines',
        name: col
      };
    });
    const layout = {
      margin:{t:30,r:20,b:50,l:60},
      xaxis:{ title:xCol },
      yaxis:{ title:'valor' },
      legend:{ orientation:'h', y:-0.2 },
      hovermode:'x unified'
    };
    Plotly.newPlot(chartDiv, traces, layout, {displaylogo:false, responsive:true});
    showMsg(`Plotado: ${current.file.name}`, true);
  }

  // --------- EVENTS ---------
  btnFind.addEventListener('click', async ()=>{
    const c = caseSel.value;
    const s = scnSel.value;
    const a = algSel.value;
    const p = pSel.value;
    const r = rdSel.value;

    const list = candidates(c,s,a,p,r);
    if(!list.length){
      current = {file:null,data:[],columns:[]};
      showMsg('Nenhum arquivo encontrado para a combinação selecionada.', false);
      xSel.innerHTML=''; yList.innerHTML='';
      Plotly.purge(chartDiv);
      return;
    }
    const file = list.length>1 ? pickLatest(list) : list[0];
    const url  = fileUrl(file);

    showMsg('Carregando '+file.name+' ...', true);
    try{
      const rows = await loadXlsx(url);
      const cols = inferNumericColumns(rows);
      current = { file, data:rows, columns:cols };
      fillColumnSelectors(cols);
      showMsg('Selecionado: '+file.name, true);
    }catch(e){
      console.error(e);
      showMsg('Erro ao ler XLSX: '+(e.message||e), false);
    }
  });

  btnPlot.addEventListener('click', plot);

  btnClear.addEventListener('click', ()=>{
    Plotly.purge(chartDiv);
    Array.from(yList.querySelectorAll('input[type=checkbox]')).forEach(cb=>cb.checked=false);
  });
})();
</script>
</body>
</html>
