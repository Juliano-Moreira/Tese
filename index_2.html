<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Explorador de Resultados (BSS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Plotly + SheetJS via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; margin:16px; color:#222}
    header{display:flex; gap:12px; flex-wrap:wrap; align-items:end}
    fieldset{border:1px solid #ddd; border-radius:10px; padding:10px 12px; margin:8px 0}
    legend{padding:0 6px; color:#555}
    select,button{padding:6px 8px; border-radius:8px; border:1px solid #ccc}
    #chart{width:100%; height:70vh; margin-top:10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .help{color:#666; font-size:0.9em}
    .pill{background:#f5f5f5; padding:2px 8px; border-radius:10px; margin-left:6px}
    .col-list{min-width:220px}
    .muted{color:#777}
    .foot{margin-top:8px; font-size:12px; color:#666}
    .warn{color:#b96}
  </style>
</head>
<body>
  <h1>Explorador de Resultados (BSS)</h1>

  <fieldset>
    <legend>Seleção de dados</legend>
    <div class="row">
      <label>Arquivo A:
        <select id="fileA"></select>
      </label>
      <label>Coluna X:
        <select id="xA" class="col-list"></select>
      </label>
      <label>Colunas Y (A):
        <select id="yA" class="col-list" multiple size="6"></select>
      </label>
    </div>
    <div class="row">
      <label>Arquivo B (comparar):
        <select id="fileB"></select>
      </label>
      <label>Colunas Y (B):
        <select id="yB" class="col-list" multiple size="6"></select>
      </label>
      <button id="btnPlot">Atualizar gráfico</button>
      <button id="btnShare">Copiar link</button>
    </div>
    <div class="help">Dica: segure <b>Ctrl</b> (ou Cmd) para selecionar múltiplas colunas Y.</div>
  </fieldset>

  <div id="chart"></div>

  <div class="foot">
    Deep link: parâmetros <code>?files=...&x=...&y=col1|col2&y2=...</code>.
    <span class="muted">Os dados são carregados sob demanda de <code>data/*.xlsx</code>.</span>
  </div>

<script>
const q = new URLSearchParams(location.search);
let INDEX = null;

async function loadIndex() {
  const res = await fetch('index.json');
  if (!res.ok) throw new Error('index.json não encontrado. Rode gen_index.py.');
  INDEX = await res.json();
}

function populateSelect(sel, options, placeholder='— selecione —') {
  sel.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = ''; opt0.textContent = placeholder;
  sel.appendChild(opt0);
  for (const o of options) {
    const opt = document.createElement('option');
    opt.value = o.value; opt.textContent = o.label ?? o.value;
    sel.appendChild(opt);
  }
}

function getFileMeta(fileName) {
  return INDEX.files.find(f => f.name === fileName);
}

async function loadXlsx(url) {
  const buf = await (await fetch(url)).arrayBuffer();
  const wb = XLSX.read(buf, {type: 'array'});
  const sheet = wb.SheetNames[0];
  const json = XLSX.utils.sheet_to_json(wb.Sheets[sheet], {defval: null});
  return json; // array de objetos {col: valor}
}

function colsFromData(rows){
  if (!rows?.length) return [];
  return Object.keys(rows[0]).map(c => String(c));
}

function tryGuessX(cols){
  const candidates = ['period','Período','Periodo','Hora','time','timestamp'];
  const lc = cols.map(c => c.toLowerCase());
  for (const cand of candidates){
    const k = lc.indexOf(cand.toLowerCase());
    if (k>=0) return cols[k];
  }
  return cols[0];
}

function setMulti(select, values){
  const toSet = new Set(values || []);
  for (const opt of select.options){
    opt.selected = toSet.has(opt.value);
  }
}

function getMulti(select){
  return [...select.options].filter(o=>o.selected && o.value).map(o=>o.value);
}

function makeTrace(rows, xKey, yKey, labelPrefix='A'){
  const x = [], y = [];
  for (const r of rows){
    x.push(r[xKey]);
    y.push(r[yKey]);
  }
  return {
    x, y, mode: 'lines', type: 'scatter',
    name: `${labelPrefix}: ${yKey}`
  };
}

function buildShareURL() {
  const fileA = document.getElementById('fileA').value;
  const fileB = document.getElementById('fileB').value;
  const xA    = document.getElementById('xA').value;
  const yA    = getMulti(document.getElementById('yA'));
  const yB    = getMulti(document.getElementById('yB'));
  const params = new URLSearchParams();
  const files = [fileA, fileB].filter(Boolean).join(',');
  if (files) params.set('files', files);
  if (xA)    params.set('x', xA);
  if (yA.length) params.set('y', yA.join('|'));
  if (yB.length) params.set('y2', yB.join('|'));
  return location.origin + location.pathname + '?' + params.toString();
}

async function plotFromUI(){
  const fileA = document.getElementById('fileA').value;
  const fileB = document.getElementById('fileB').value;
  const xA    = document.getElementById('xA').value;
  const yA    = getMulti(document.getElementById('yA'));
  const yB    = getMulti(document.getElementById('yB'));

  const traces = [];
  let rowsA = null, rowsB = null;

  if (fileA) {
    const metaA = getFileMeta(fileA);
    rowsA = await loadXlsx(metaA.url);
    for (const y of yA) traces.push(makeTrace(rowsA, xA, y, 'A'));
  }
  if (fileB) {
    const metaB = getFileMeta(fileB);
    rowsB = await loadXlsx(metaB.url);
    const xB = xA; // alinhar nos mesmos rótulos
    for (const y of yB) traces.push(makeTrace(rowsB, xB, y, 'B'));
  }

  const layout = {
    title: 'Séries selecionadas',
    xaxis: {title: xA || ''},
    yaxis: {title: 'valor'},
    legend: {orientation: 'h'},
    margin: {t: 40, r: 10, l: 50, b: 50}
  };

  Plotly.newPlot('chart', traces, layout, {responsive:true});
}

async function main(){
  await loadIndex();

  const fileA = document.getElementById('fileA');
  const fileB = document.getElementById('fileB');
  const xA    = document.getElementById('xA');
  const yA    = document.getElementById('yA');
  const yB    = document.getElementById('yB');

  const fileOptions = INDEX.files.map(f => ({value: f.name, label: f.name}));
  populateSelect(fileA, fileOptions, '— Arquivo A —');
  populateSelect(fileB, [{value:'',label:'(nenhum)'}].concat(fileOptions), '— Arquivo B —');

  // Reagir à troca de arquivo A → preencher colunas
  fileA.addEventListener('change', async ()=>{
    const meta = getFileMeta(fileA.value);
    if (!meta) { populateSelect(xA, []); populateSelect(yA, []); return; }
    // Carrega poucas linhas para descobrir colunas reais
    const rows = await loadXlsx(meta.url);
    const cols = colsFromData(rows);
    populateSelect(xA, cols.map(c=>({value:c})));
    populateSelect(yA, cols.map(c=>({value:c})));
    xA.value = tryGuessX(cols);
  });

  // Reagir à troca de arquivo B → preencher colunas
  fileB.addEventListener('change', async ()=>{
    const meta = getFileMeta(fileB.value);
    if (!meta || !fileB.value) { populateSelect(yB, []); return; }
    const rows = await loadXlsx(meta.url);
    const cols = colsFromData(rows);
    populateSelect(yB, cols.map(c=>({value:c})));
  });

  document.getElementById('btnPlot').onclick = plotFromUI;
  document.getElementById('btnShare').onclick = ()=>{
    const url = buildShareURL();
    navigator.clipboard.writeText(url);
    alert('Link copiado:\n' + url);
  };

  // Deep link: files, x, y, y2
  const filesParam = (q.get('files')||'').split(',').filter(Boolean);
  const xParam     = q.get('x');
  const yParam     = (q.get('y')||'').split('|').filter(Boolean);
  const y2Param    = (q.get('y2')||'').split('|').filter(Boolean);

  if (filesParam[0]) fileA.value = filesParam[0];
  if (filesParam[1]) fileB.value = filesParam[1];

  // dispare eventos para carregar colunas e setar seleções
  if (fileA.value){
    await fileA.dispatchEvent(new Event('change'));
    if (xParam) xA.value = xParam;
    if (yParam.length) setMulti(yA, yParam);
  }
  if (fileB.value){
    await fileB.dispatchEvent(new Event('change'));
    if (y2Param.length) setMulti(yB, y2Param);
  }

  // Se vier por link, plote automaticamente
  if (filesParam.length || yParam.length) { plotFromUI(); }
}

main().catch(err=>{
  document.getElementById('chart').innerHTML =
    `<p class="warn">Erro ao inicializar: ${err}</p>`;
});
</script>
</body>
</html>
